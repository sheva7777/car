华为技术有限公司

研究管理部文档中心	产品版本	密级
	MA5600TV8R5C032	内部公开
	产品名称：MA5600T	共17页

MA5600T系统GPON单板CAR测试方法
(仅供内部使用)






拟制:	康静41052		日期：	2007-3-29
审核:			日期：	
审核:			日期：	
批准:			日期：	






华为技术有限公司
版权所有  侵权必究

修订记录
日期	修订版本	描述	作者
2007-3-29	1.00	初稿完成	康静
2007-3-30	2.00	修改完成	康静
			
			
			
			
			
			
			
			
			
 
目  录
概述	6
1	MA5600T产品中CAR的实现	6
2 GPON单板上TM逻辑对CAR的实现	8
3 报文速率测试方法分析	9
2.1 PIR参数测试	9
2.2 CIR参数测试	10
2.3 利用调试命令测试CIR和PIR	13
2.4 报文速率测试关注点	14
4 报文突发测试方法分析	14
3.1 CBS参数测试方法	15
3.2 PBS参数测试方法	16
3.3 关于CBS和PBS测试的说明	17
3.4 报文突发测试关注点	18
5 总结	18

 
MA5600T系统GPON单板CAR测试方法
关键词： GPON、QOS、流分类、CAR 、队列调度、T-CONT
摘    要：本文对MA5600T产品种GPON系统对CAR的实现和处理进行了描述，分析了CAR模板中各个参数的实际意义，并提供了在GPON单板上对其测试的有效方法。
缩略语清单： 			
Abbreviations缩略语	Full spelling 英文全名	Chinese explanation 中文解释
PON	Passive Optical Network	无源光网络
GPON	Gbit Passive Optical Network	Gbit无源光网络
FTTH	Fiber To The Home	光纤到户
FTTO	Fiber To The Office	光纤到办公室
OLT	Optical Line Termination	光线路终端
ONT	Optical Network Termination	光网络终端
DBA	Dynamic Bandwidth Allocation	动态带宽调整
SBA	Static Bandwidth Allocation	静态带宽调整
SDH	Synchronous Digital Hierarchy 	同步数字系列
CAR	Committed Access Rate	允许访问速率
QOS	Quality of Service	服务质量
IGMP	Internet Group Management Protocol	因特网组管理协议
GEM	G-PON Encapsulation Method	GPON封装方法
TDM	Time Division Multiple Access	时分复用
PQ	Priority Queue	优先级队列
WRR	Weight Round Robin	加权轮循
CoS	Class of Service	服务类型
TOS	Type of Service	服务类型
VLAN	Virtual Local Area Network	虚拟局域网
		
		
		
		

 
 概述
MA5600T产品支持了GPON单板。报文上下行转发过程中，GPON系统中采用两种机制实现QOS。一种是使用以太网中QOS一样的技术，比如流分类，访问速度（CAR），队列调度等等。另外一种就是GPON中特有的带宽分配技术DBA。DBA技术的原理和测试方法在作者的另一篇文档中（《GPON中DBA的实现与测试指导》）已经进行了详细的阐述。本文中分析了CAR模板中各个参数的意义，对GPON产品上CAR的测试方法进行阐述，并就一些特殊测试方法进行详细地解析。下面就对MA5600T产品中CAR的实现做一个概要的介绍，并分析了GPON单板中TM逻辑对于CAR的处理和实现过程。
1	 MA5600T产品中CAR的实现
在MA5600T V800R005中，QoS的流量控制是通过双速率三色流控功能完成的。下面的描述，引用自《MA5600 V800R005 流分类与QoS技术分析报告》，该文对QoS的实现从TR101协议的层面进行了分析。
“双速率三色流量管理功能就是双速率三色标记算法。RFC2698规定每一个IP业务流都具有4个流量参数，承诺信息速率（CIR）、承诺突发度（CBS）、峰值信息速率（PIR）、峰值突发度（PBS）。根据这4个参数，用一种双速率三色标记算法（trTCM）对IP业务流中的IP包逐个进行度量，根据度量结果将每个IP包打上不同的颜色。
 
图1 	双速率三色标记算法工作流程
度量使用两个令牌桶，桶P和桶C，其最大尺寸分别为PBS和CBS，初始情况下两个令牌桶都是满的。每秒钟分别向两个桶放入PIR、CIR数量的令牌，但桶内的令牌总数不能超过桶的最大尺寸。下面分别用Tp(t)、Tc(t)表示时刻t桶P和桶C中令牌的数量。两个桶的示意图如下所示；
 
图2 	P桶C桶示意图

双速率三色标记算法有两种工作模式，Color-Blind模式和Color-Aware模式，前者不关心IP包原来是什么颜色，后者需要考虑IP包原来的颜色。如果在时刻t收到一个大小为B的IP包，两种模式分别作如下的处理。
在Color-Blind模式下，
	如果Tp(t) - B < 0，那么IP包被标记为红色。否则执行下一步；
	如果Tc(t) - B < 0，那么IP包被标记为黄色，并且Tp减少B。否则执行下一步；
	IP包被标记为绿色，并且Tp和Tc都减少B。
在Color-Aware模式下，
	如果IP包原来是红色的，或者Tp(t) - B < 0，那么IP包被标记为红色。否则执行下一步；
	如果IP包原来是黄色的，或者Tc(t) - B < 0，那么IP包被标记为黄色，并且Tp减少B。否则执行下一步；
	IP包被标记为绿色，并且Tp和Tc都减少B。”
MA5600T V800R005中，在逻辑上实现了上述的双速率三色流量控制功能。在IP流量摸板中，增加了CIR、PIR、CBS、PBS、CM等参数。其中CM参数表示采用Color-Blind模式还是采用Color-Aware模式。CIR表示平均速度限制，PIR表示峰值速率限制，CBS表示平均突发度限制，PBS表示峰值突发度限制。当建立业务流的时候，通过绑定IP流量摸板，把相关流量参数下发到逻辑中，从而实现基于业务流的双速率三色流量管理；在MA5600T中，颜色的标记是通过DEI来标志的，DEI的位置如图2所示：
 
图3 	DEI在VLAN标签中的位置图
当DEI=0时，表示报文为绿色报文；当DEI=1时，表示报文为黄色报文。对于红色报文，系统是直接丢弃的，因此不需要特殊的标记。
2 GPON单板上TM逻辑对CAR的实现
CAR是TM逻辑进行报文流量控制的方式，有上行转发、下行转发和上行交CPU三种。上行和下行报文转发流量控制是对业务流进行的，粒度为64kbps；上行交CPU流量的控制是对Gemport进行的，粒度为2pps（送CPU的处理本文不做考虑）。目前，上下行转发流量可以通过主机流量模板进行设置和修改，在主机上配置完毕后下发到单板，写寄存器；通过命令：H801GPBC>show tm table 12可以查询上行CAR设置寄存器，通过命令：H801GPBC>show tm table 13可以查询下行CAR寄存器。 
TM逻辑使用双令牌桶来实现CAR功能。TM内部有两个独立的令牌桶P桶和C桶，大小（深度）分别是PBS、CBS。在初始时刻（t=0），两个桶中的令牌都是满的，即，Tp(0) = PBS，Tc(0) = CBS。在运行过程中，TM逻辑每125us向P桶和C桶各加1次令牌（P桶每次增加令牌数量 = PBS * 0.125 bytes，C桶每次增加令牌大小 = CBS * 0.125 bytes），但P桶和C桶的令牌总量不能超出它们的最大值PBS和CBS。
  在收到长度为B字节的IP报文时，对于Color-Blind模式各令牌桶算法如下：
	如果P桶令牌数量小于B字节，则报文为红色（直接丢弃）；
	否则（P桶令牌数量大于等于B字节），如果C桶令牌数量小于B字节，则报文为黄色，同时P桶令牌数量减少B字节；
	否则（C桶令牌数量大于等于B字节），则报文为绿色，同时P桶和C桶令牌数量均减少B字节。
      对于Color-Aware模式各令牌桶算法如下：
	如果报文本身是红色或P桶令牌数量小于B字节，则报文为红色（直接丢弃）；
	否则（报文本身是黄色或P桶令牌数量大于等于B字节），如果C桶令牌数量小于B字节，则报文为黄色，同时P桶令牌数量减少B字节；
	否则（报文本身是绿色或C桶令牌数量大于等于B字节），则报文为绿色，同时P桶和C桶令牌数量均减少B字节。
目前，系统仅支持Color-Blind模式的报文颜色处理，即，可以对输出报文进行颜色标记，但不识别输入报文的颜色标志。
3 报文速率测试方法分析
从应用场景分析，大部分情况下DSLAM上的流控只在上行方向有意义，在下行方向流量控制点应该在上层的网络设备。所以可以重点针对该业务流的上行方向进行流控测试。但是GPON系统对于上行和下行的处理方式是一致的，上行带宽除了受到CAR限制外还受到T-CONT的限制。下行带宽则完全是由CAR模板限制的。
关于双速率三色流量控制功能的测试，主要是验证系统是否能够按照下发的CIR、PIR、CBS、PBS对带宽进行有效的控制。要正确的指导测试，首先需要深刻的理解CIR、PIR、CBS、PBS和实际报文速率以及报文突发度的关系。在测试中，我们从两个方向关注：报文速率和报文突发度。
3.1 PIR参数测试
报文速率是由CAR模板中PIR这个参数决定的。根据前面对CAR原理分析得知，在系统转发报文的时候，如果报文速率小于CIR，则系统标记成为绿色，正常转发。如果报文速率大于CIR小于PIR，则报文被标为黄色，但是在GPON系统中依然正常转发；如果速率大于PIR，则GPON系统将其丢弃（如下图4所示）。所以在GPON系统中给一条流配置了CAR模板，那么最大速率应该等于该CAR模板的PIR值。
 
图4 	双速率三色流量控制原理图
在测试中，CAR对于速率限制的测试比较简单。配置CAR模板INDEX=200的PIR等于50M，建立service-port下行绑定这个CAR模板。使用SMB下行发送100M的流量，观察ONT接收报文流量的速率大小。使用SMB发送和接收速率如下图所示。使用包长124，下行100M的发送速率等于84457/s,接收速率等于42216/S。由于接收是发送的一半，因此接收速率等于100/2，等于50M。所以PIR准确。
 
图5 	PIR测试结果
MA5680(config)#display traffic table ip index 200
  --------------------------------------------
  TD Index         : 200
  Priority         : 0
  Copy Priority    : -
  Priority Policy  : local-pri
  CIR              : 9984 kbps
  CBS              : 10000 bytes
  PIR              : 49984 kbps
  PBS              : 20000 bytes
  Referenced Status: used
  --------------------------------------------
表1：PIR测试CAR配置
3.2 CIR参数测试

要测试CIR参数就是要观察在转发的报文中，多少报文标记成为绿色，多少报文标记成为黄色。在上面的例子中，CIR等于10000，PIR等于50000。测试CIR是否准确就是观察是否转发的50000报文中有10000标记成为绿色，另外40000标记成为黄色。那么报文中标志的颜色究竟是哪一位呢？如下图6所示，我们抓出的报文就是一个被标志成为黄色的报文，DEI为1。
 
图6 	DEI标志位
那么在实际测试中如何分别观察黄色报文和绿色报文的是否符合PIR和CIR呢？下面提供一个方法。我们使用SMB两个GE卡上下行对发1G流量。但是配置业务虚端口绑定CAR模板的PIR等于100M，CIR等于10M。配置如下面所示。
MA5680(config)# display traffic table ip index 200
  --------------------------------------------
  TD Index         : 200
  Priority         : 0
  Copy Priority    : -
  Priority Policy  : local-pri
  CIR              : 9984 kbps
  CBS              : 10000 bytes
  PIR              : 99968 kbps
  PBS              : 20000 bytes
  Referenced Status: used
  --------------------------------------------
表2：CIR测试CAR配置
使用SMB转发报文时，观察报文速率统计信息。由于系统转发速率等于PIR，我们需要观察CIR的值，因此我们在SMB上进行Trigger设置。根据上面抓包中DEI的位置，我们设置偏移量等于14，长度为1个字节，内容为00（标志成绿色的报文为00，标志成黄色的报文为10）。具体配置见下图7。完成设置后我们使用SMB观察报文转发速率的统计信息，测试结果见图8。Trigger速率的大小为发送速率的百分之一，因此为1G/100等于10M。接收速率大小为发送速率的十分之一，因此为1G/10等于100M。这两个值和CIR与PIR设置相吻合。
 
图7 	Trigger配置

 
图8 	CIR测试结果
3.3 利用调试命令测试CIR和PIR 
除了上述使用SMB能够观察CIR和PIR是否准确外，GPON系统可以使用调试命令，能够更加准确的观察系统对绿色和黄色报文处理是否准确。
建立CAR模板，具体配置如下所示：
MA5680(config)#display traffic table ip index 509
             --------------------------------------------
             TD Index         : 509
             Priority         : 0
             Copy Priority    : -
             Priority Policy  : local-pri
 CIR              : 5952 kbps
             CBS              : 2000 bytes
             PIR              : 11968 kbps
             PBS              : 5000 bytes
             Referenced Status: used
             --------------------------------------------
表3. 调试命令测试中CAR设置
首先使用单板串口调试命令清除GPON逻辑TM的统计信息。命令为：H801GPBC>clear tm statistic all。然后使用测试仪器发包一阵子，几秒钟就可以了。然后使用命令统计TM的报文转发个数。命令为：H801GPBC>show tm statistic ptype。通过统计信息可以看出下行转发报文数量，这是GPON单板的TM逻辑总共转发报文数量。通过统计信息可以看出上行报文转发个数为：00238269
H801GPBC>show tm statistic ptype
=============== FORWARD ========================================================
 Upstream:
Recv correct frame from PON                                  [080]: 00238269
 Dnstream:
Recv correct frame from GE                                   [064]: 00118419
=============== DISCARD ========================================================
 Upstream:
Drop frame for CAR                                           [120]: 01920430
 Dnstream:
Drop frame for CAR                                           [122]: 19654662
Dnstream queue 7 of port 0 is full                           [167]: 00119700
=============== TOCPU ==========================================================
 Upstream:
Dnstream:
show ptype finished
然后使用命令：show tm indirect-reg 0x86000 20查询寄存器统计信息。寄存器显示信息的第二行的最后四位显示了黄色报文的个数（统计信息如表4所示）。通过读取这个数据然后和刚才的00238269相除，观察黄色报文个数在总报文个数中的比例是否和设置相同。这样就可以方便的测试出各种情况下CIR和PIR设置是否正确。通过计算得实际：119776/238269=0.5029，和设置相符合。
H801GPBC>show tm indirect-reg 0x86000 20
0x00086000: 00000000 08400400 0020f06b 0020f06b
0x00086010: 4daed3e0 4daed3e0 4daed3e0 4daed3e0
0x00086020: 00000000 08400400 0020f06b 0020f06b
0x00086030: 4daed3e0 4daed3e0 4daed3e0 4daed3e0
0x00086040: 00000000 08400400 0020f06b 0020f06b
表4：黄色报文个数
3.4 报文速率测试关注点
测试关注点：在测试中可以考虑CIR和PIR在边界值情况下实际报文标记个数是否和设置一致；在CIR和PIR设置大小一致的情况下实际报文标记情况；在CIR和PIR两者设置差别很小的情况下，实际报文标记情况是否同设置一致；在CIR和PIR差别很大情况下，实际报文标记情况是否同设置一致
4 报文突发测试方法分析
在CAR模板中，除了PIR和CIR外还有两个参数，这就是CBS和PBS。这两个参数反应了系统对于突发流量的处理能力。当使用测试仪发送突发流量的时候，令牌来不及调度，所以报文转发从桶里取令牌，因此桶的深度反应了系统抗突发的能力。在CAR模板设置是要求PBS大于CBS，报文首先从CBS取令牌，在C桶取出一个令牌后P桶也减少一个。当C桶中CBS个令牌都取走后再从P桶中继续取。还能够取PBS-CBS个令牌。当然，这样的计算是在系统没有向两个桶里放置令牌的时候，如果125us过后，令牌增加，那么报文转发使用的令牌不仅包含CBS和PBS，还包括了CIRH和PIR（具体分析见3.3）。因此如果一条业务流绑定了一个CAR模板，那么它最大抗突发度是由PBS决定的。在测试中我们应该分别观察CBS和PBS是否准确。
4.1 CBS参数测试方法
为了验证CBS是否准确就要把其他参数的影响降低到最低。因此配置PIR和CIR等于64，配置PBS等于CBS。之所以设置PBS等于CBS是由于C桶令牌取完后，P桶也取完了，这样测试效果反应的是C桶的。具体配置如下所示。需要注意的是，CBS和PBS单位是字节。下面就用一个实际测试的例子观察绿桶深度如何测试。CAR配置如表5所示。
MA5680(config)#display traffic table ip index
{ row-index<U><0,511> }:200
  Command:
          display traffic table ip index 200
  --------------------------------------------
  TD Index         : 200
  Priority         : 0
  Copy Priority    : -
  Priority Policy  : local-pri
  CIR              : 64 kbps
  CBS              : 10000 bytes
  PIR              : 64 kbps
  PBS              : 10000 bytes
  Referenced Status: used
  --------------------------------------------
表5：CBS测试CAR配置
建立业务流绑定上面的CAR模板200。使用SMB下行发送single burst突发报文，速率设置成为1G，发送1000个报文，字节长度为100。使用SMB观察报文发送和接收个数，结果如下图9所示。接收到81个报文，结果正确。为什么81个报文结果正确呢？我们现在算算看。SMB发送报文长度是100，在GPON设备中添加20个字节的前导码，再添加4个字节的CRC字段，因此实际转发报文长度一个为124字节。CAR模板中设置CBS为10000字节。10000/124＝81个字节。通过测试结果我们可以看出这个值配置准确。此时大家可能产生的问题是，为什么CIR和PIR作用没有体现那？新令牌没有放入桶中么？原因请参见3.3。
 
图9 	CBS测试结果
4.2 PBS参数测试方法
参数PBS反应了黄桶的深度。如果报文收到突发速率后绿桶令牌调度完毕就会到黄桶中继续获取令牌。因此修改上述CAR模板的PBS等于50000，依然使用SMB发送1000个报文，报文长度是100。
MA5680(config)#display traffic table ip index
{ row-index<U><0,511> }:200
  Command:
          display traffic table ip index 200
  --------------------------------------------
  TD Index         : 200
  Priority         : 0
  Copy Priority    : -
  Priority Policy  : local-pri
  CIR              : 64 kbps
  CBS              : 10000 bytes
  PIR              : 64 kbps
  PBS              : 50000 bytes
  Referenced Status: used
  --------------------------------------------
表6：PBS测试CAR配置
使用SMB统计报文接收个数，测试结果如下图10所示。同CBS测试结果进行比较，发现接收报文个数从81增长到403个，增加了4倍。这是由于PBS从10000增加到50000，黄色报文个数增加了4倍。通过设置SMB的Triggers我们可以统计出绿色报文个数为80个，比例正确，符合黄绿报文设置比例。除了使用Triggers观察黄色或者绿色报文个数外，我们依然可以使用上文提到的调试命令查询寄存器读数来测试黄色报文个数。
 
图10 	PBS测试结果
4.3 关于CBS和PBS测试的说明
在测试中，我们为了减少PIR和CIR参数对CBS和PBS的影响，因此把PIR和CIR设置成为64。其实，PIR和CIR是令牌往两个桶里放入的速率，为了反应桶深（PBS和CBS）就要减少放入令牌对桶里令牌深度的影响。系统每125us往桶里放入令牌，如果我们报文突发能够在125us完成，那么令牌还没有来得及放入桶中之前，数据转发就完成了，数据转发使用的令牌完全是桶里的令牌,报文转发个数就完全反应了令牌桶的深度。
在测试中我们使用SMB以1G的速率发送1000个报文，测试结果准确，这是由于报文在125us之内就已经转发完成了。如果发送报文个数较多，那么发送时间较长。125us之内没有发完，那么桶里再次放入了令牌，这样的测试结果将会比仅仅使用PBS计算得到的偏大。比如我们调整上面测试中的设置，把SMB发送报文个数从1000个调整到100000个，这样SMB发送报文时间增加，测试结果如下图11所示。又结果可以看出报文转发个数915个大于我们先前测试的403。这是由于每125us，都有令牌重新进入令牌桶中。
 
图11 	PBS,CBS测试结果

4.4 报文突发测试关注点
测试关注点：在测试中可以考虑CBS和PBS在边界值情况下实际报文标记个数是否和设置一致；在PBS和CBS设置大小一致的情况下实际报文标记情况；在PBS和CBS两者设置差别很小的情况下，实际报文标记情况是否同设置一致；在CIR和PIR差别很大情况下，实际报文标记情况是否同设置一致
5 总结
本文讨论了MA5600T系统中CAR的实现，重点讨论了GPON单板TM逻辑CAR的实现。在文中对CAR的各个参数的以及通过实际的例子进行了详细的说明，对每个参数的测试方法也给出了具体的例子。除了使用测试仪器的一般测试方法外，还给出了在GPON单板使用调试命令方便的进行测试的方法。

